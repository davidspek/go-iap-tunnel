name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum
      - name: Run go mod download
        run: go mod download
      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9.2.0

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum
      - name: Run go mod download
        run: go mod download
      - name: Run unit tests
        continue-on-error: true
        run: |
          go run gotest.tools/gotestsum@latest --format testname --jsonfile test-results.json -- -race -coverprofile coverage.cover ./...
      - name: Convert Unit Tests
        continue-on-error: true
        run: |
          go run github.com/ctrf-io/go-ctrf-json-reporter/cmd/go-ctrf-json-reporter@latest -output ctrf-report.json < test-results.json
      - name: Publish Test Report
        uses: ctrf-io/github-test-reporter@024bc4b64d997ca9da86833c6b9548c55c620e40 # v1.0.26
        with:
          report-path: ctrf-report.json
          group-by: suite
          summary-report: true
          failed-report: true
          flaky-report: true
          skipped-report: true
          suite-folded-report: true
          exit-on-fail: true

  gosec:
    name: Gosec & Govulncheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Set up Go
        uses: actions/setup-go@7a3fe6cf4cb3a834922a1244abfce67bcef6a0c5 # v6.2.0
        with:
          go-version-file: go.mod
          cache-dependency-path: go.sum
      - name: Run go mod download
        run: go mod download
      - name: Run govulncheck
        id: govulncheck
        continue-on-error: true
        run: go install golang.org/x/vuln/cmd/govulncheck@latest && govulncheck -format sarif ./... > govulncheck.sarif
      - name: Upload govulncheck SARIF
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
        with:
          sarif_file: govulncheck.sarif
      # - name: Run gosec # TODO: enable once gosec releases a version with go 1.25.6 support
      #   uses: securego/gosec@424fc4cd9c82ea0fd6bee9cd49c2db2c3cc0c93f # v2.22.11
      #   id: gosec
      #   with:
      #     args: '-no-fail -fmt sarif -out gosec.sarif ./...'
      - name: Run gosec
        id: gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest && gosec -no-fail -fmt sarif -out gosec.sarif ./...
      - name: Upload gosec SARIF
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
        with:
          sarif_file: gosec.sarif
      - name: Fail if govulncheck or gosec found issues
        if: steps.gosec.outcome == 'failure' || steps.govulncheck.outcome == 'failure'
        run: |
          echo "govulncheck or gosec found issues"
          exit 1

  trivy:
    name: Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          scan-type: fs
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
          ignore-unfixed: true
      - name: Upload Trivy SARIF
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
        with:
          sarif_file: trivy-results.sarif
